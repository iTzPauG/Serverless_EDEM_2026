steps:
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    id: Build Dataflow Flex Template
    args: ['dataflow', 'flex-template', 'build',
           'gs://$_DATAFLOW_BASE_BUCKET/$_DATAFLOW_TEMPLATE_NAME.json',
           '--image-gcr-path=$_REGION_ID-docker.pkg.dev/$PROJECT_ID/$_ARTIFACT_REGISTRY_REPOSITORY/$_ARTIFACT_REGISTRY_IMAGE_NAME:$COMMIT_SHA',
           '--flex-template-base-image=PYTHON3',
           '--sdk-language=PYTHON',
           '--py-path=.',
           '--env=FLEX_TEMPLATE_PYTHON_PY_FILE=$_DATAFLOW_PYTHON_FILE_PATH',
           '--env=FLEX_TEMPLATE_PYTHON_REQUIREMENTS_FILE=$_DATAFLOW_REQUIREMENTS_FILE_PATH'
    ]
    waitFor: ['-']
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    id: Run Dataflow Flex Template
    args: ['dataflow', 'flex-template', 'run', '$_DATAFLOW_JOB_NAME',
           '--template-file-gcs-location=gs://$_DATAFLOW_BASE_BUCKET/$_DATAFLOW_TEMPLATE_NAME.json',
           '--parameters=project_id=$PROJECT_ID,playback_pubsub_topic=$_PLAYBACK_PUBSUB_TOPIC,engagement_pubsub_topic=$_ENGAGEMENT_PUBSUB_TOPIC,quality_pubsub_topic=$_QUALITY_PUBSUB_TOPIC,notifications_pubsub_topic=$_NOTIFICATIONS_PUBSUB_TOPIC,firestore_collection=$_FIRESTORE_COLLECTION_NAME,bigquery_dataset=$_BIGQUERY_DATASET,user_bigquery_table=$_USER_BIGQUERY_TABLE,episode_bigquery_table=$_EPISODE_BIGQUERY_TABLE',
           '--region=$_REGION_ID',
           '--max-workers=1'
    ]
    waitFor: ['Build Dataflow Flex Template']
options:
  logging: STACKDRIVER_ONLY
substitutions:
  _DATAFLOW_BASE_BUCKET: <YOUR_STAGING_BUCKET_NAME>
  _DATAFLOW_JOB_NAME: <YOUR_DATAFLOW_JOB_NAME>
  _DATAFLOW_TEMPLATE_NAME: <YOUR_TEMPLATE_NAME>
  _REGION_ID: <YOUR_REGION_ID>
  _ARTIFACT_REGISTRY_REPOSITORY: <YOUR_REPOSITORY_NAME>
  _ARTIFACT_REGISTRY_IMAGE_NAME: <YOUR_IMAGE_NAME>
  _DATAFLOW_PYTHON_FILE_PATH: <YOUR_PATH_TO_THE_PY_FILE>
  _DATAFLOW_REQUIREMENTS_FILE_PATH: <YOUR_PATH_TO_THE_REQUIREMENTS_FILE>
  _PLAYBACK_PUBSUB_TOPIC: <YOUR_PLAYBACK_PUBSUB_TOPIC>
  _ENGAGEMENT_PUBSUB_TOPIC: <YOUR_ENGAGEMENT_PUBSUB_TOPIC>
  _QUALITY_PUBSUB_TOPIC: <YOUR_QUALITY_PUBSUB_TOPIC>
  _NOTIFICATIONS_PUBSUB_TOPIC: <YOUR_NOTIFICATIONS_PUBSUB_TOPIC>
  _FIRESTORE_COLLECTION_NAME: <YOUR_FIRESTORE_COLLECTION_NAME>
  _BIGQUERY_DATASET: <YOUR_BIGQUERY_DATASET>
  _USER_BIGQUERY_TABLE: <YOUR_USER_BIGQUERY_TABLE>
  _EPISODE_BIGQUERY_TABLE: <YOUR_EPISODE_BIGQUERY_TABLE>
